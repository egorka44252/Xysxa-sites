// === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SPOTIFY ===
// –í–ê–ñ–ù–û: –ü–æ–ª—É—á–∏ —Å–≤–æ–∏ –∫–ª—é—á–∏ –Ω–∞ https://developer.spotify.com/dashboard
const SPOTIFY_CLIENT_ID = '–í–ê–®_CLIENT_ID'; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π
const SPOTIFY_CLIENT_SECRET = '–í–ê–®_CLIENT_SECRET'; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π
let spotifyAccessToken = null;

// === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
const RAW_BASE = 'https://raw.githubusercontent.com/egorka44252/Xysxa-sites/main';
const COVER_URL = RAW_BASE + '/img/logo.jpg';

// –°–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ —Å —Ç–µ–∫—Å—Ç–∞–º–∏ –ø–µ—Å–µ–Ω
const tracks = [
  { 
    title: '–ø–∏–ø—Å–∏–∫–∏ –¥–æ—Ä–∏—Ç–æ—Å xD', 
    file: '–ø–∏–ø—Å–∏–∫–∏_–¥–æ—Ä–∏—Ç–æ—Å_xD.mp3',
    duration: '2:45',
    artist: 'Xysxa',
    cover: COVER_URL,
    isLocal: true,
    lyrics: [
      { time: 0, text: '–ü–∏–ø—Å–∏–∫–∏ –¥–æ—Ä–∏—Ç–æ—Å, —Ö—Ä—É—Å—Ç—è—â–∏–π –∑–≤—É–∫' },
      { time: 5, text: '–í –ø–∞—á–∫–µ —Ä–∞–¥–æ—Å—Ç—å, –∑–∞–±—ã–≤–∞—é –≥—Ä—É—Å—Ç—å' },
      { time: 10, text: '–ö–∞–∂–¥—ã–π —á–∏–ø –∫–∞–∫ –º–∞–ª–µ–Ω—å–∫–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫' },
      { time: 15, text: '–°—ã—Ä–Ω—ã–π –≤–∫—É—Å, –Ω–µ –º–æ–≥—É –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è' },
      { time: 20, text: 'XD —Å–º–µ—é—Å—å, –Ω–∞—Å–ª–∞–∂–¥–∞—è—Å—å –º–æ–º–µ–Ω—Ç–æ–º' },
      { time: 25, text: '–ü–∏–ø—Å–∏–∫–∏ –¥–æ—Ä–∏—Ç–æ—Å - –º–æ–π –≤—ã–±–æ—Ä –Ω–æ–º–µ—Ä –æ–¥–∏–Ω' }
    ]
  },
  { 
    title: '–ë—ç–∫–≤—É–¥', 
    file: '–ë—ç–∫–≤—É–¥.mp3',
    duration: '3:20',
    artist: 'Xysxa',
    cover: COVER_URL,
    isLocal: true,
    lyrics: [
      { time: 0, text: '–í –ª–µ—Å—É —Ç–µ–º–Ω–æ–º, –≥–¥–µ —Ç–µ–Ω–∏ –∏–≥—Ä–∞—é—Ç' },
      { time: 6, text: '–ë—ç–∫–≤—É–¥ –∑–æ–≤–µ—Ç –º–µ–Ω—è –≤ —Å–≤–æ–∏ –æ–±—ä—è—Ç—å—è' },
      { time: 12, text: '–î–µ—Ä–µ–≤—å—è —à–µ–ø—á—É—Ç –¥—Ä–µ–≤–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏' },
      { time: 18, text: '–Ø –∏–¥—É –≤–ø–µ—Ä–µ–¥, –Ω–µ –∑–Ω–∞—è –¥–æ—Ä–æ–≥–∏' },
      { time: 24, text: '–ë—ç–∫–≤—É–¥, –±—ç–∫–≤—É–¥ - –º–æ–π –¥–æ–º —Ä–æ–¥–Ω–æ–π' },
      { time: 30, text: '–ó–¥–µ—Å—å —è –Ω–∞—Ö–æ–∂—É –ø–æ–∫–æ–π –∏ —Å–≤–æ–±–æ–¥—É' }
    ]
  },
  { 
    title: '–î–∏—Å–∫–ª–µ–π–º–µ—Ä', 
    file: '–î–∏—Å–∫–ª–µ–π–º–µ—Ä.mp3',
    duration: '2:55',
    artist: 'Xysxa',
    cover: COVER_URL,
    isLocal: true,
    lyrics: [
      { time: 0, text: '–î–∏—Å–∫–ª–µ–π–º–µ—Ä: –≤—Å–µ —á—Ç–æ –∑–¥–µ—Å—å —É—Å–ª—ã—à–∏—à—å' },
      { time: 5, text: '–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –º—É–∑—ã–∫–∞, –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–≤–∞' },
      { time: 10, text: '–ù–µ –ø—Ä–∏–Ω–∏–º–∞–π –≤—Å–µ—Ä—å–µ–∑ –∫–∞–∂–¥—ã–π –∑–≤—É–∫' },
      { time: 15, text: '–≠—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ, —ç—Ç–æ –∏–≥—Ä–∞' },
      { time: 20, text: '–î–∏—Å–∫–ª–µ–π–º–µ—Ä –≤–∞–∂–µ–Ω, –∑–∞–ø–æ–º–Ω–∏ —ç—Ç–æ' },
      { time: 25, text: '–ú—ã —Å–æ–∑–¥–∞–µ–º, —Ç—ã –Ω–∞—Å–ª–∞–∂–¥–∞–µ—à—å—Å—è' }
    ]
  }
];

// === –≠–õ–ï–ú–ï–ù–¢–´ DOM ===
let audioPlayer, playBtn, prevBtn, nextBtn, progressBar, volumeSlider, muteBtn;
let trackName, trackArtist, trackTime, currentTimeEl, totalTimeEl, coverImg;
let volumeValue, playIcon, pauseIcon, volumeIcon, muteIcon, musicPlayer;
let lyricsToggle, lyricsSection, lyricsContent, closeLyrics;
let themeToggle, sunIcon, moonIcon;
let playlistToggle, playlistMenu, playlistMenuContent, closePlaylist;
let spotifySearchInput, searchBtn, searchResults;

// === –°–û–°–¢–û–Ø–ù–ò–ï ===
let currentTrackIndex = 0;
let isPlaying = false;
let isMuted = false;
let previousVolume = 1;
let lyricsVisible = false;
let playlistVisible = false;
let currentTheme = 'dark';
let currentTrack = null;

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
document.addEventListener('DOMContentLoaded', () => {
  console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–µ–µ—Ä–∞...');
  initializeElements();
  initializeBackgroundVideo();
  getSpotifyToken();
  loadPlaylistMenu();
  loadTrack(0);
  attachEventListeners();
  loadTheme();
  console.log('–ü–ª–µ–µ—Ä –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
function initializeElements() {
  audioPlayer = document.getElementById('audio-player');
  playBtn = document.getElementById('play-btn');
  prevBtn = document.getElementById('prev-btn');
  nextBtn = document.getElementById('next-btn');
  progressBar = document.getElementById('progress-bar');
  volumeSlider = document.getElementById('volume-slider');
  muteBtn = document.getElementById('mute-btn');
  trackName = document.getElementById('track-name');
  trackArtist = document.getElementById('track-artist');
  trackTime = document.getElementById('track-time');
  currentTimeEl = document.getElementById('current-time');
  totalTimeEl = document.getElementById('total-time');
  coverImg = document.getElementById('cover-img');
  volumeValue = document.getElementById('volume-value');
  playIcon = document.getElementById('play-icon');
  pauseIcon = document.getElementById('pause-icon');
  volumeIcon = document.getElementById('volume-icon');
  muteIcon = document.getElementById('mute-icon');
  musicPlayer = document.querySelector('.music-player');
  lyricsToggle = document.getElementById('lyrics-toggle');
  lyricsSection = document.getElementById('lyrics-section');
  lyricsContent = document.getElementById('lyrics-content');
  closeLyrics = document.getElementById('close-lyrics');
  themeToggle = document.getElementById('theme-toggle');
  sunIcon = document.getElementById('sun-icon');
  moonIcon = document.getElementById('moon-icon');
  playlistToggle = document.getElementById('playlist-toggle');
  playlistMenu = document.getElementById('playlist-menu');
  playlistMenuContent = document.getElementById('playlist-menu-content');
  closePlaylist = document.getElementById('close-playlist');
  spotifySearchInput = document.getElementById('spotify-search-input');
  searchBtn = document.getElementById('search-btn');
  searchResults = document.getElementById('search-results');
  
  if (!audioPlayer) console.error('–ê—É–¥–∏–æ –ø–ª–µ–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!');
  if (!playBtn) console.error('–ö–Ω–æ–ø–∫–∞ Play –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
}

// === SPOTIFY API ===
async function getSpotifyToken() {
  try {
    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + btoa(SPOTIFY_CLIENT_ID + ':' + SPOTIFY_CLIENT_SECRET)
      },
      body: 'grant_type=client_credentials'
    });
    
    const data = await response.json();
    spotifyAccessToken = data.access_token;
    console.log('Spotify —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ Spotify:', error);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Spotify. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á–∏ –≤ script.js');
  }
}

async function searchSpotify(query) {
  if (!spotifyAccessToken) {
    await getSpotifyToken();
  }
  
  if (!query || query.trim() === '') {
    searchResults.style.display = 'none';
    return;
  }
  
  try {
    const response = await fetch(
      `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`,
      {
        headers: {
          'Authorization': 'Bearer ' + spotifyAccessToken
        }
      }
    );
    
    const data = await response.json();
    displaySearchResults(data.tracks.items);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ Spotify:', error);
  }
}

function displaySearchResults(tracks) {
  if (!tracks || tracks.length === 0) {
    searchResults.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üò¢</div>';
    searchResults.style.display = 'block';
    return;
  }
  
  searchResults.innerHTML = '';
  searchResults.style.display = 'block';
  
  tracks.forEach(track => {
    const resultItem = document.createElement('div');
    resultItem.className = 'search-result-item';
    
    const coverUrl = track.album.images[2]?.url || track.album.images[0]?.url || COVER_URL;
    const artists = track.artists.map(a => a.name).join(', ');
    const duration = formatSpotifyDuration(track.duration_ms);
    
    resultItem.innerHTML = `
      <div class="result-item-cover">
        <img src="${coverUrl}" alt="Cover">
      </div>
      <div class="result-item-info">
        <div class="result-item-title">${track.name}</div>
        <div class="result-item-artist">${artists}</div>
      </div>
      <div class="result-item-duration">${duration}</div>
      <button class="result-item-play-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
      </button>
    `;
    
    resultItem.querySelector('.result-item-play-btn').addEventListener('click', () => {
      loadSpotifyTrack(track);
      searchResults.style.display = 'none';
      spotifySearchInput.value = '';
    });
    
    searchResults.appendChild(resultItem);
  });
}

function formatSpotifyDuration(ms) {
  const minutes = Math.floor(ms / 60000);
  const seconds = ((ms % 60000) / 1000).toFixed(0);
  return `${minutes}:${seconds.padStart(2, '0')}`;
}

function loadSpotifyTrack(spotifyTrack) {
  if (!spotifyTrack.preview_url) {
    alert('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –¥–ª—è —ç—Ç–æ–≥–æ —Ç—Ä–µ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–≤—å—é üò¢\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ç—Ä–µ–∫!');
    return;
  }
  
  const track = {
    title: spotifyTrack.name,
    artist: spotifyTrack.artists.map(a => a.name).join(', '),
    file: spotifyTrack.preview_url,
    cover: spotifyTrack.album.images[1]?.url || spotifyTrack.album.images[0]?.url || COVER_URL,
    duration: formatSpotifyDuration(spotifyTrack.duration_ms),
    isLocal: false,
    isSpotify: true
  };
  
  currentTrack = track;
  trackName.textContent = track.title;
  trackArtist.textContent = track.artist;
  audioPlayer.src = track.file;
  coverImg.src = track.cover;
  
  audioPlayer.load();
  progressBar.value = 0;
  updateProgressBackground();
  
  playTrack();
  
  console.log('Spotify —Ç—Ä–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω:', track.title);
}

// === –§–û–ù–û–í–û–ï –í–ò–î–ï–û ===
function initializeBackgroundVideo() {
  const video = document.getElementById('bg-video');
  if (video) {
    video.addEventListener('loadeddata', () => {
      console.log('–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
    });
    
    video.addEventListener('error', (e) => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', e);
    });
    
    const playPromise = video.play();
    if (playPromise !== undefined) {
      playPromise.then(() => {
        console.log('–í–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è');
      }).catch(error => {
        console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:', error);
      });
    }
  }
}

// === –ó–ê–ì–†–£–ó–ö–ê –ú–ï–ù–Æ –ü–õ–ï–ô–õ–ò–°–¢–ê ===
function loadPlaylistMenu() {
  playlistMenuContent.innerHTML = '';
  
  tracks.forEach((track, index) => {
    const trackItem = document.createElement('div');
    trackItem.className = 'playlist-track-item';
    trackItem.setAttribute('data-index', index);
    
    if (index === currentTrackIndex && currentTrack?.isLocal) {
      trackItem.classList.add('active');
    }
    
    trackItem.innerHTML = `
      <div class="track-item-number">${index + 1}</div>
      <div class="track-item-cover">
        <img src="${track.cover}" alt="Cover">
        <div class="track-item-play-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </div>
      </div>
      <div class="track-item-info">
        <div class="track-item-title">${track.title}</div>
        <div class="track-item-artist">${track.artist}</div>
      </div>
      <div class="track-item-duration">${track.duration}</div>
    `;
    
    trackItem.addEventListener('click', () => {
      loadTrack(index);
      playTrack();
      updatePlaylistMenu();
    });
    
    playlistMenuContent.appendChild(trackItem);
  });
  
  console.log(`–ú–µ–Ω—é –ø–ª–µ–π–ª–∏—Å—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${tracks.length} —Ç—Ä–µ–∫–æ–≤`);
}

function updatePlaylistMenu() {
  const items = playlistMenuContent.querySelectorAll('.playlist-track-item');
  items.forEach((item, index) => {
    if (index === currentTrackIndex && currentTrack?.isLocal) {
      item.classList.add('active');
    } else {
      item.classList.remove('active');
    }
  });
}

// === –ó–ê–ì–†–£–ó–ö–ê –¢–†–ï–ö–ê ===
function loadTrack(index) {
  if (index < 0 || index >= tracks.length) {
    console.error('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Ç—Ä–µ–∫–∞:', index);
    return;
  }
  
  currentTrackIndex = index;
  const track = tracks[index];
  currentTrack = track;
  
  console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–∞: ${track.title}`);
  
  trackName.textContent = track.title;
  trackArtist.textContent = track.artist;
  
  if (track.isLocal) {
    const trackUrl = RAW_BASE + '/music/' + encodeURIComponent(track.file);
    audioPlayer.src = trackUrl;
  } else {
    audioPlayer.src = track.file;
  }
  
  coverImg.src = track.cover;
  
  audioPlayer.load();
  
  progressBar.value = 0;
  updateProgressBackground();
  
  updateLyrics();
  updatePlaylistMenu();
  
  console.log(`–¢—Ä–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω`);
}

// === –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï / –ü–ê–£–ó–ê ===
function togglePlay() {
  if (!audioPlayer.src) {
    console.warn('–ò—Å—Ç–æ—á–Ω–∏–∫ –∞—É–¥–∏–æ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    return;
  }
  
  if (isPlaying) {
    pauseTrack();
  } else {
    playTrack();
  }
}

function playTrack() {
  const playPromise = audioPlayer.play();
  
  if (playPromise !== undefined) {
    playPromise.then(() => {
      isPlaying = true;
      updatePlayButton();
      musicPlayer.classList.add('playing');
      console.log('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—á–∞—Ç–æ');
    }).catch(error => {
      console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
      isPlaying = false;
      updatePlayButton();
    });
  }
}

function pauseTrack() {
  audioPlayer.pause();
  isPlaying = false;
  updatePlayButton();
  musicPlayer.classList.remove('playing');
  console.log('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
}

function updatePlayButton() {
  if (isPlaying) {
    playIcon.style.display = 'none';
    pauseIcon.style.display = 'block';
  } else {
    playIcon.style.display = 'block';
    pauseIcon.style.display = 'none';
  }
}

// === –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –¢–†–ï–ö–ê–ú ===
function previousTrack() {
  if (currentTrack?.isSpotify) {
    // –ï—Å–ª–∏ –∏–≥—Ä–∞–µ—Ç Spotify —Ç—Ä–µ–∫, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ª–æ–∫–∞–ª—å–Ω–æ–º—É
    loadTrack(tracks.length - 1);
  } else {
    const newIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
    loadTrack(newIndex);
  }
  
  if (isPlaying) {
    setTimeout(() => playTrack(), 100);
  }
}

function nextTrack() {
  if (currentTrack?.isSpotify) {
    // –ï—Å–ª–∏ –∏–≥—Ä–∞–µ—Ç Spotify —Ç—Ä–µ–∫, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–µ—Ä–≤–æ–º—É –ª–æ–∫–∞–ª—å–Ω–æ–º—É
    loadTrack(0);
  } else {
    const newIndex = (currentTrackIndex + 1) % tracks.length;
    loadTrack(newIndex);
  }
  
  if (isPlaying) {
    setTimeout(() => playTrack(), 100);
  }
}

// === –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –í–†–ï–ú–ï–ù–ò ===
function formatTime(seconds) {
  if (isNaN(seconds) || seconds === Infinity || seconds < 0) {
    return '00:00';
  }
  
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}

// === –û–ë–ù–û–í–õ–ï–ù–ò–ï –í–†–ï–ú–ï–ù–ò ===
function updateTime() {
  const current = audioPlayer.currentTime;
  const duration = audioPlayer.duration;
  
  if (!isNaN(current) && isFinite(current)) {
    currentTimeEl.textContent = formatTime(current);
  }
  
  if (!isNaN(duration) && isFinite(duration)) {
    totalTimeEl.textContent = formatTime(duration);
    trackTime.textContent = `${formatTime(current)} / ${formatTime(duration)}`;
    
    const percentage = (current / duration) * 100;
    progressBar.value = percentage;
    updateProgressBackground();
  }
  
  if (lyricsVisible) {
    highlightLyrics(current);
  }
}

// === –ü–†–û–ì–†–ï–°–° –ë–ê–† ===
function updateProgressBackground() {
  const value = progressBar.value || 0;
  progressBar.style.background = `linear-gradient(90deg, #ff6ec4 ${value}%, rgba(255,255,255,0.2) ${value}%)`;
}

function seekTrack() {
  const duration = audioPlayer.duration;
  if (!isNaN(duration) && isFinite(duration) && duration > 0) {
    const seekTime = (progressBar.value / 100) * duration;
    audioPlayer.currentTime = seekTime;
    console.log(`–ü–µ—Ä–µ–º–æ—Ç–∫–∞ –Ω–∞: ${formatTime(seekTime)}`);
  }
}

// === –ì–†–û–ú–ö–û–°–¢–¨ ===
function updateVolume() {
  const volume = volumeSlider.value / 100;
  audioPlayer.volume = volume;
  volumeValue.textContent = `${Math.round(volumeSlider.value)}%`;
  
  updateVolumeIcon(volume);
  
  if (volume === 0) {
    isMuted = true;
  } else {
    isMuted = false;
  }
}

function updateVolumeIcon(volume) {
  if (volume === 0 || isMuted) {
    volumeIcon.style.display = 'none';
    muteIcon.style.display = 'block';
  } else {
    volumeIcon.style.display = 'block';
    muteIcon.style.display = 'none';
  }
}

function toggleMute() {
  if (isMuted || audioPlayer.volume === 0) {
    const newVolume = previousVolume > 0 ? previousVolume : 1;
    audioPlayer.volume = newVolume;
    volumeSlider.value = newVolume * 100;
    isMuted = false;
    console.log('–ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω');
  } else {
    previousVolume = audioPlayer.volume;
    audioPlayer.volume = 0;
    volumeSlider.value = 0;
    isMuted = true;
    console.log('–ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω');
  }
  
  volumeValue.textContent = `${Math.round(volumeSlider.value)}%`;
  updateVolumeIcon(audioPlayer.volume);
}

// === –ú–ï–ù–Æ –ü–õ–ï–ô–õ–ò–°–¢–ê ===
function togglePlaylistMenu() {
  playlistVisible = !playlistVisible;
  
  if (playlistVisible) {
    playlistMenu.style.display = 'block';
    playlistToggle.classList.add('active-control');
    setTimeout(() => {
      playlistMenu.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
  } else {
    playlistMenu.style.display = 'none';
    playlistToggle.classList.remove('active-control');
  }
}

// === –¢–ï–ö–°–¢ –ü–ï–°–ù–ò ===
function toggleLyrics() {
  lyricsVisible = !lyricsVisible;
  
  if (lyricsVisible) {
    lyricsSection.style.display = 'block';
    lyricsToggle.classList.add('active-control');
    updateLyrics();
    setTimeout(() => {
      lyricsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
  } else {
    lyricsSection.style.display = 'none';
    lyricsToggle.classList.remove('active-control');
  }
}

function updateLyrics() {
  if (!currentTrack || !currentTrack.isLocal || !currentTrack.lyrics || currentTrack.lyrics.length === 0) {
    lyricsContent.innerHTML = '<p class="no-lyrics">–¢–µ–∫—Å—Ç –¥–ª—è —ç—Ç–æ–≥–æ —Ç—Ä–µ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>';
    return;
  }
  
  lyricsContent.innerHTML = '';
  
  currentTrack.lyrics.forEach((line, index) => {
    const p = document.createElement('p');
    p.className = 'lyrics-line';
    p.setAttribute('data-time', line.time);
    p.setAttribute('data-index', index);
    p.textContent = line.text;
    
    p.addEventListener('click', () => {
      audioPlayer.currentTime = line.time;
      if (!isPlaying) {
        playTrack();
      }
    });
    
    lyricsContent.appendChild(p);
  });
}

function highlightLyrics(currentTime) {
  if (!currentTrack || !currentTrack.lyrics) return;
  
  const lines = lyricsContent.querySelectorAll('.lyrics-line');
  let activeIndex = -1;
  
  for (let i = currentTrack.lyrics.length - 1; i >= 0; i--) {
    if (currentTime >= currentTrack.lyrics[i].time) {
      activeIndex = i;
      break;
    }
  }
  
  lines.forEach((line, index) => {
    if (index === activeIndex) {
      line.classList.add('active');
      line.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else if (index < activeIndex) {
      line.classList.remove('active');
      line.classList.add('passed');
    } else {
      line.classList.remove('active', 'passed');
    }
  });
}

// === –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –¢–ï–ú ===
function toggleTheme() {
  currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
  applyTheme(currentTheme);
  saveTheme(currentTheme);
}

function applyTheme(theme) {
  const body = document.body;
  
  if (theme === 'light') {
    body.classList.add('light-theme');
    sunIcon.style.display = 'none';
    moonIcon.style.display = 'block';
  } else {
    body.classList.remove('light-theme');
    sunIcon.style.display = 'block';
    moonIcon.style.display = 'none';
  }
  
  console.log(`–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: ${theme}`);
}

function saveTheme(theme) {
  localStorage.setItem('xysxa-theme', theme);
}

function loadTheme() {
  const savedTheme = localStorage.getItem('xysxa-theme') || 'dark';
  currentTheme = savedTheme;
  applyTheme(currentTheme);
}

// === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===
function attachEventListeners() {
  playBtn.addEventListener('click', togglePlay);
  prevBtn.addEventListener('click', previousTrack);
  nextBtn.addEventListener('click', nextTrack);
  
  progressBar.addEventListener('input', () => {
    seekTrack();
    updateProgressBackground();
  });
  
  volumeSlider.addEventListener('input', updateVolume);
  muteBtn.addEventListener('click', toggleMute);
  
  lyricsToggle.addEventListener('click', toggleLyrics);
  closeLyrics.addEventListener('click', toggleLyrics);
  
  playlistToggle.addEventListener('click', togglePlaylistMenu);
  closePlaylist.addEventListener('click', togglePlaylistMenu);
  
  themeToggle.addEventListener('click', toggleTheme);
  
  // –ü–æ–∏—Å–∫ Spotify
  searchBtn.addEventListener('click', () => {
    searchSpotify(spotifySearchInput.value);
  });
  
  spotifySearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      searchSpotify(spotifySearchInput.value);
    }
  });
  
  // –ñ–∏–≤–æ–π –ø–æ–∏—Å–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
  let searchTimeout;
  spotifySearchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchSpotify(e.target.value);
    }, 500);
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.spotify-search-section')) {
      searchResults.style.display = 'none';
    }
  });
  
  audioPlayer.addEventListener('loadedmetadata', () => {
    const duration = audioPlayer.duration;
    if (!isNaN(duration) && isFinite(duration)) {
      totalTimeEl.textContent = formatTime(duration);
      currentTimeEl.textContent = '00:00';
      trackTime.textContent = `00:00 / ${formatTime(duration)}`;
      console.log(`–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞: ${formatTime(duration)}`);
    }
  });
  
  audioPlayer.addEventListener('timeupdate', updateTime);
  
  audioPlayer.addEventListener('ended', () => {
    console.log('–¢—Ä–µ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω, –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É');
    nextTrack();
    if (isPlaying) {
      setTimeout(() => playTrack(), 100);
    }
  });
  
  audioPlayer.addEventListener('play', () => {
    isPlaying = true;
    updatePlayButton();
    musicPlayer.classList.add('playing');
  });
  
  audioPlayer.addEventListener('pause', () => {
    isPlaying = false;
    updatePlayButton();
    musicPlayer.classList.remove('playing');
  });
  
  audioPlayer.addEventListener('error', (e) => {
    console.error('–û—à–∏–±–∫–∞ –∞—É–¥–∏–æ:', e);
    console.error('–ö–æ–¥ –æ—à–∏–±–∫–∏:', audioPlayer.error ? audioPlayer.error.code : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
  });
  
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
      return;
    }
    
    switch(e.code) {
      case 'Space':
        e.preventDefault();
        togglePlay();
        break;
      case 'ArrowLeft':
        e.preventDefault();
        if (audioPlayer.duration) {
          audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
        }
        break;
      case 'ArrowRight':
        e.preventDefault();
        if (audioPlayer.duration) {
          audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
        }
        break;
      case 'ArrowUp':
        e.preventDefault();
        volumeSlider.value = Math.min(100, parseInt(volumeSlider.value) + 10);
        updateVolume();
        break;
      case 'ArrowDown':
        e.preventDefault();
        volumeSlider.value = Math.max(0, parseInt(volumeSlider.value) - 10);
        updateVolume();
        break;
      case 'KeyM':
        e.preventDefault();
        toggleMute();
        break;
      case 'KeyL':
        e.preventDefault();
        toggleLyrics();
        break;
      case 'KeyP':
        e.preventDefault();
        togglePlaylistMenu();
        break;
      case 'KeyT':
        e.preventDefault();
        toggleTheme();
        break;
      case 'KeyS':
        e.preventDefault();
        spotifySearchInput.focus();
        break;
    }
  });
  
  console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
}

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ì–†–û–ú–ö–û–°–¢–ò ===
if (audioPlayer) {
  audioPlayer.volume = 1;
  volumeSlider.value = 100;
  volumeValue.textContent = '100%';
  updateVolumeIcon(1);
}

window.addEventListener('error', (e) => {
  console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', e.message);
});

window.addEventListener('keydown', (e) => {
